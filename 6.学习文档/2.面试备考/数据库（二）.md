# 数据库（二）

### 1.什么是主键？什么是外键？ 

* 主键

  * 概念：是被挑选出来，作表的行的惟一标识的候选关键字。一个表只有一个主关键字。主关键字又可以称为主键。 主键可以由一个字段，也可以由多个字段组成，分别称为单字段主键或多字段主键。

    > 简单说：用来唯一的约束该字段里面的数据，不能重复，不能为空。一张表中最多只能有一个主键

  * 作用

    1）保证实体的完整性;
    2）加快数据库的操作速度
    3）在表中添加新记录时，DBMS会自动检查新记录的主键值，不允许该值与其他记录的主键值重复。
    4) DBMS自动按主键值的顺序显示表中的记录。如果没有定义主键，则按输入记录的顺序显示表中的记录

* 外键

  * 概念：如果公共关键字在一个关系中是主关键字，那么这个公共关键字被称为另一个关系的外键。由此可见，外键表示了两个关系之间的相关联系。以另一个关系的外键作主关键字的表被称为主表，具有此外键的表被称为主表的从表。外键又称作外关键字。

  * 表的外键是另一表的主键, 一个表可以有多个外键，外键可以有重复的, 可以是空值

    > 用于定义主表和从表之间的关系：外键约束主要定义在从表上，主表则必须是有主键约束或unique约束。当定义外键后，要求外键列数据必须在主表的主键列存在或为null。

  * 作用：外键主要是用来控制数据库中的数据完整性的，当对一个表的数据进行操作时，和他有关联的一个表或多个表的数据能够同时发生改变

### 2.什么是死锁，产生原因是什么？如何避免？ 

* 简述死锁

  * 是指两个或两个以上的进程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。由于资源占用是互斥的，当某个进程提出申请资源后，使得有关进程在无外力协助下，永远分配不到必需的资源而无法继续运行，这就产生了一种特殊现象死锁。

    > 如果线程A锁住了记录1并等待记录2，而线程B锁住了记录2并等待记录1，这样两个线程就发生了死锁现象。

* 产生死锁的原因

  * 系统资源不足。
  * 进程运行推进的顺序不合适。
  * 资源分配不当等。

  如果系统资源充足，进程的资源请求都能够得到满足，死锁出现的可能性就很低，否则就会因争夺有限的资源而陷入死锁。其次，进程运行推进顺序与速度不同，也可能产生死锁。

* 产生死锁的四个必要条件

  （1） 互斥条件：一个资源每次只能被一个进程使用。

  （2） 请求与保持条件：一个进程因请求资源而阻塞时，对已获得的资源保持不放。

  （3） 不剥夺条件:进程已获得的资源，在末使用完之前，不能强行剥夺。

  （4） 循环等待条件:若干进程之间形成一种头尾相接的循环等待资源关系。

    这四个条件是死锁的必要条件，只要系统发生死锁，这些条件必然成立，而只要上述条件之一不满足，就不会发生死锁。

* 如何尽可能避免死锁

  1）以固定的顺序访问表和行。即按顺序申请锁，这样就不会造成互相等待的场面。

  2）大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。

  3）在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁概率。

  4）降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR（可重复读）调整为RC（读取提交内容），可以避免掉很多因为gap锁（间隙锁）造成的死锁。

  5）为表添加合理的索引。如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。

  * 银行家算法

  操作系统按照银行家制定的规则为进程分配资源，当进程首次申请资源时，要测试该进程对资源的最大需求量，如果系统现存的资源可以满足它的最大需求量则按当前的申请量分配资源，否则就推迟分配。当进程在执行中继续申请资源时，先测试该进程已占用的资源数与本次申请的资源数之和是否超过了该进程对资源的最大需求量。若超过则拒绝分配资源，若没有超过则再测试系统现存的资源能否满足该进程尚需的最大资源量，若能满足则按当前的申请量分配资源，否则也要推迟分配。

### 3.什么是共享锁，什么是互斥锁？

* 互斥锁

  也称为排他锁、写锁，是悲观锁，可以写为X锁，指的是同时只能有一个事务可以对某个资源进行访问操作。就是我们对数据进行写操作的时候，要先获得写锁，获得写锁的事务既可以写数据也可以读数据。但是，如果数据库已经被别人增加了排他写锁，那么后面的事务是无法在获得该数据库的任何锁的。

  > 如果事务T对数据A加上排他锁后，则其他事务不能再对A加任何类型的封锁。获准排他锁的事务既能读数据，又能修改数据。

* 共享锁

  又称之为读锁，共享锁是一种乐观锁，可以写为S锁，在数据库中共享锁的作用主要是针对读取操作的。如果读取操作使用X锁的话，并发量会非常低，所以数据库提供了共享锁S锁，提高读取操作的并发性能，多个事务可以同时持有一个资源的S锁，不像X锁，同时只能有一个事务持有。

  > 如果事务T对数据A加上共享锁后，则其他事务只能对A再加共享锁，不能加排他锁。获准共享锁的事务只能读数据，不能修改数据。



